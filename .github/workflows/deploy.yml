name: Deploy RAIDHack

on:
    push:
        branches: [ master ]  # mainã‹ã‚‰masterã«å¤‰æ›´
    pull_request:
        branches: [ master ]  # mainã‹ã‚‰masterã«å¤‰æ›´
        types: [ opened, synchronize, reopened, closed ]
    workflow_dispatch:

permissions:
    contents: read
    pull-requests: write
    issues: write

jobs:
    deploy-api:
        if: github.event.action != 'closed'
        runs-on: ubuntu-latest
        name: Deploy Workers API
        outputs:
            api-url: ${{ steps.deploy-api.outputs.api-url }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: api/package-lock.json

            - name: Install API dependencies
              run: |
                  cd api
                  npm ci

            - name: Deploy Workers API
              id: deploy-api
              run: |
                  cd api
                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                      # PRç”¨ã®ç’°å¢ƒ: raidhack-api-pr-{PRç•ªå·}
                      WORKER_NAME="raidhack-api-pr-${{ github.event.number }}"
                      API_URL="https://${WORKER_NAME}.ukawamochi5.workers.dev"
                  else
                      # æœ¬ç•ªç’°å¢ƒ
                      WORKER_NAME="raidhack-api"
                      API_URL="https://raidhack-api.ukawamochi5.workers.dev"
                  fi
                  
                  echo "Deploying to: $API_URL"
                  npx wrangler deploy --minify --name "$WORKER_NAME"
                  echo "api-url=$API_URL" >> $GITHUB_OUTPUT
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        env:
            CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

    deploy-web:
        if: github.event.action != 'closed'
        runs-on: ubuntu-latest
        name: Deploy Pages
        needs: deploy-api
        outputs:
            pages-url: ${{ steps.deploy-pages.outputs.pages-url }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: web/package-lock.json

            - name: Install Web dependencies
              run: |
                  cd web
                  npm ci

            - name: Build React app
              run: |
                  cd web
                  npm run build
              env:
                  REACT_APP_API_BASE: ${{ needs.deploy-api.outputs.api-url }}

            - name: Deploy to Cloudflare Pages
              id: deploy-pages
              run: |
                  cd web
                  # å˜ä¸€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ–ãƒ©ãƒ³ãƒãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤
                  PROJECT_NAME="raidhack-web"
                  
                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                      # PRç”¨: ãƒ–ãƒ©ãƒ³ãƒåã¨ã—ã¦PRç•ªå·ã‚’ä½¿ç”¨
                      BRANCH_NAME="pr-${{ github.event.number }}"
                      echo "Deploying PR to branch: $BRANCH_NAME"
                      output=$(npx wrangler@latest pages deploy dist --project-name "$PROJECT_NAME" --branch "$BRANCH_NAME" 2>&1)
                      # PRç”¨ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’ç”Ÿæˆ
                      PAGES_URL="https://${BRANCH_NAME}.raidhack-web.pages.dev"
                  else
                      # æœ¬ç•ªç”¨: productionãƒ–ãƒ©ãƒ³ãƒ
                      echo "Deploying to production"
                      output=$(npx wrangler@latest pages deploy dist --project-name "$PROJECT_NAME" --branch "production" 2>&1)
                      PAGES_URL="https://raidhack-web.pages.dev"
                  fi
                  
                  echo "$output"
                  
                  # å‡ºåŠ›ã‹ã‚‰å®Ÿéš›ã®URLã‚’å–å¾—ã‚’è©¦è¡Œ
                  actual_url=$(echo "$output" | grep -oE 'https://[a-zA-Z0-9\-\.]+\.pages\.dev' | head -1)
                  if [ -n "$actual_url" ]; then
                      PAGES_URL="$actual_url"
                  fi
                  
                  echo "pages-url=$PAGES_URL" >> $GITHUB_OUTPUT
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

            - name: Comment PR with deployment info
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const pagesUrl = '${{ steps.deploy-pages.outputs.pages-url }}';
                      const apiUrl = '${{ needs.deploy-api.outputs.api-url }}';
                      
                      const comment = `## ğŸš€ PRç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
                      
                      ã“ã®PR (#${{ github.event.number }}) ã®å¤‰æ›´ãŒå°‚ç”¨ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸï¼š
                      
                      - **Webã‚¢ãƒ—ãƒª**: ${pagesUrl}
                      - **API**: ${apiUrl}
                      
                      å„PRã”ã¨ã«ç‹¬ç«‹ã—ãŸç’°å¢ƒã§å‹•ä½œã—ã¾ã™ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                      
                      > **Note**: ã“ã®ç’°å¢ƒã¯PRãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã‚‹ã¨è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`;
                      
                      github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: comment
                      });

    cleanup:
        if: github.event.action == 'closed'
        runs-on: ubuntu-latest
        name: Cleanup PR Environment
        steps:
            - name: Delete Workers API
              run: |
                  WORKER_NAME="raidhack-api-pr-${{ github.event.number }}"
                  echo "Deleting Worker: $WORKER_NAME"
                  npx wrangler delete "$WORKER_NAME" --force || echo "Worker $WORKER_NAME not found or already deleted"
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

            - name: Comment PR cleanup
              uses: actions/github-script@v7
              with:
                  script: |
                      const comment = `## ğŸ§¹ PRç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†
                      
                      ã“ã®PRã®å°‚ç”¨ç’°å¢ƒãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼š
                      
                      - ~~API: raidhack-api-pr-${{ github.event.number }}.ukawamochi5.workers.dev~~
                      - ~~Web: pr-${{ github.event.number }}.raidhack-web.pages.dev~~
                      
                      ãƒªã‚½ãƒ¼ã‚¹ãŒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚`;
                      
                      github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: comment
                      });